<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>TBMM Kelime Analizi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; color: #333; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 90%; max-width: 1000px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 5px; color: #2c3e50; }
        .subtitle { color: #7f8c8d; margin-bottom: 30px; font-size: 0.9em; }
        
        .search-box { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        input { padding: 12px; width: 300px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: #c0392b; outline: none; }
        button { padding: 12px 25px; background: #c0392b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #e74c3c; transform: translateY(-2px); }

        #uyariKutusu {
            display: none;
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-size: 0.9em;
            text-align: center;
        }

        canvas { margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>TBMM Tutanaklarında Kelime Ara</h1>
        <p class="subtitle">Veriler takvim yıllarına göre normalize edilmiştir.</p>
        
        <div class="search-box">
            <input type="text" id="aramaKutusu" placeholder="Aranacak kelime (örn: demokrasi)">
            <button onclick="kelimeGetir()">Analiz Et</button>
        </div>

        <div id="uyariKutusu">⚠️ <strong>Dikkat:</strong> Seçilen yıl için veri kaynağı çok az (20'den az oturum). Düşüş normal olabilir.</div>

        <canvas id="grafikTablosu"></canvas>
    </div>

    <script>
        let tumVeri = {};
        let mevcutGrafik = null;

        fetch('veri.json')
            .then(response => response.json())
            .then(data => {
                tumVeri = data;
                console.log("Veri yüklendi!");
            });

        function kelimeGetir() {
            const kelime = document.getElementById('aramaKutusu').value.toLowerCase().trim();
            const uyari = document.getElementById('uyariKutusu');
            uyari.style.display = 'none';

            if (!tumVeri[kelime]) {
                alert("Kelime bulunamadı!");
                return;
            }

            const veriObjesi = tumVeri[kelime];
            // Yılları sıralayalım (String oldukları için sayısal sıralama yapmalıyız)
            const yillar = Object.keys(veriObjesi).sort((a, b) => parseInt(a) - parseInt(b));
            
            const sayilar = [];
            const metaBilgiler = [];
            const dosyaSayilari = [];

            yillar.forEach(yil => {
                sayilar.push(veriObjesi[yil].count);
                metaBilgiler.push(veriObjesi[yil].meta);
                dosyaSayilari.push(veriObjesi[yil].files);
            });

            cizGrafik(kelime, yillar, sayilar, metaBilgiler, dosyaSayilari);
        }

        function cizGrafik(label, labels, data, meta, files) {
            const ctx = document.getElementById('grafikTablosu').getContext('2d');
            const uyari = document.getElementById('uyariKutusu');

            if (mevcutGrafik) {
                mevcutGrafik.destroy();
            }

            // Düşük verili noktaları kırmızı yapmak için renk dizisi oluştur
            const pointColors = files.map(f => f < 20 ? 'red' : 'rgb(192, 57, 43)');
            const pointRadiuses = files.map(f => f < 20 ? 6 : 4);

            mevcutGrafik = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `"${label}" kelimesi (Yıllık Toplam)`,
                        data: data,
                        borderColor: 'rgb(192, 57, 43)',
                        pointBackgroundColor: pointColors, // Nokta renkleri
                        pointRadius: pointRadiuses,        // Nokta büyüklüğü
                        borderWidth: 2,
                        tension: 0.3,
                        fill: {
                            target: 'origin',
                            above: 'rgba(192, 57, 43, 0.1)'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                // Tooltip içine detayları ekle
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const dosyaSayisi = files[index];
                                    const donemAdi = meta[index];
                                    
                                    let uyariMetni = "";
                                    if (dosyaSayisi < 20) {
                                        uyari.style.display = 'block';
                                        uyari.innerHTML = `⚠️ <strong>${labels[index]} Yılı (${donemAdi}):</strong> Sadece ${dosyaSayisi} dosya var. Veri az olduğu için grafik düşük görünebilir.`;
                                        uyariMetni = "\n⚠️ (Yetersiz Veri Kaynağı!)";
                                    } else {
                                        uyari.style.display = 'none';
                                    }

                                    return [
                                        `------------------`,
                                        `Dönem: ${donemAdi}`,
                                        `Dosya Kaynağı: ${dosyaSayisi} adet`,
                                        uyariMetni
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>